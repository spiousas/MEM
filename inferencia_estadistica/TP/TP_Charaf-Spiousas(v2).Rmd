---
title: "TP Inferencia Estad铆stica"
author: "Jesica Charaf e Ignacio Spiousas"
date: "25 de junio de 2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, latex2exp)
```

# El problema

Una fuente radiactiva emite part铆culas alfa de acuerdo con un proceso de Poisson de intensidad $\lambda$ por segundo. Se tiene una fuerte sospecha de que el par谩metro desconocido supera
$0.5$, y con el objetivo de confirmar dicha sospecha se medir谩n los tiempos entre emisiones consecutivas, obteniendo de esa manera una muestra de variables aleatorias independientes
con distribuci贸n $\mathcal E(\lambda)$.

Se proponen dos alternativas, con respecto a la construcci贸n del test de hip贸tesis:

1. Armar un test de nivel exacto $\alpha$ a partir del estad铆stico $T_1 = \sum_{i=1}^n X_i$.

2. Armar un test de nivel asint贸tico $\alpha$ a partir del estad铆stico $T_2 = \sqrt{n} \frac{\bar{X}-2}{2}$

El objetivo es comparar ambos m茅todos mediante una simulaci贸n en **R**, para luego elegir uno de ellos y realizar el experimento. Para cada valor de $n \in \{10, 30, 100, 1000\}$ se quiere estudiar el nivel emp铆rico, y compararlo para las dos alternativas propuestas. Tambi茅n se desea aproximar y graficar la funci贸n potencia, y comparar.

Consideramos el siguiente procedimiento para la simulaci贸n:

* Generar una muestra de tama帽o n de una distribuci贸n $\mathcal E(\frac{1}{2})$

* Calcular el valor del estad铆stico $T$ para los dos test propuestos. Rechazar $H_0$ si el p-valor es menor al nivel $0.05$.

* Repetir los 铆tems anteriores $N_{rep} = 10000$ veces, contando el total de veces en que se rechaz贸 $H_0$. Se puede estimar el nivel de este test como la proporci贸n emp铆rica de rechazos, es decir, dividiendo la cantidad total de rechazos por $N_{rep}$, para cada valor de $n$, y armar una tabla con los resultados obtenidos.

Se pide:

a. Plantear claramente las hip贸tesis.

b. Justificar la elecci贸n de los dos estad铆sticos que propone el enunciado, y determinar sus distribuciones (exacta o asint贸tica) bajo $H_0$.

c. Realizar la simulaci贸n pedida para los diferentes valores de $n$, calcular el nivel emp铆rico y expresarlo en una tabla.

d. Para cada uno de los valores propuestos de $n$ y eligiendo una grilla de valores para $\lambda$, aproximar y graficar la funci贸n potencia.

e. Concluir en base a los resultados observados.

# La resoluci贸n

## a. Plantear claramente las hip贸tesis.

Consideramos que lo razonable es que la hip贸tesis nula sea que el par谩metro **NO** supera el valor de $0.5$ y la hip贸tesis alternativa que **S** lo supera. Como dice el enunciado, se tiene la "sospecha" de que es mayor, por ende, el *status quo* es que el par谩metro es menor. Simb贸licamente:

$$
\begin{aligned}
H_0: \lambda \leq 0.5 \quad \quad y \quad \quad H_1: \lambda > 0.5
\end{aligned}
$$

## b. Justificar la elecci贸n de los dos estad铆sticos que propone el enunciado, y determinar sus distribuciones (exacta o asint贸tica) bajo $H_0$.

Primero vamos a desarrollar el **test de nivel exacto** $\alpha$.

Partimos de que las mediciones son i.i.d y tienen la siguiente distribuci贸n:

$$
\begin{aligned}
X_1,...,X_n \overset{i.i.d}\sim \mathcal E(\lambda)
\end{aligned}
$$

O sea que la funci贸n de densidad de cada $X$ es:

$$
\begin{aligned}
f_X(x) = \lambda e^{-\lambda x} \mathcal{I}_{\{x \geq0\}}
\end{aligned}
$$

Justamente por ser independientes, la densidad condicional se puede escribir como la productoria de las densidades individuales

$$
\begin{aligned}
f(\underset{\bar{}}{x}) = \prod_{i=1}^{n} \lambda e^{-\lambda x_i} \mathcal{I}_{\{x_i \geq0\}}
\end{aligned}
$$

Y por ser idnticamente distribuidas podemos operar y llegar a:

$$
\begin{aligned}
f(\underset{\bar{}}{x}) = \lambda^{n} e^{-\lambda \sum_{i=1}^n x_i} \prod_{i=1}^{n} \mathcal{I}_{\{x_i \geq0\}}
\end{aligned}
$$

De este resultado podemos ver que se trata de una distribuci贸n de familia exponencial donde:

$$
\begin{aligned}
A(\lambda) &= \lambda^n \\
C(\lambda) &= -\lambda \\
r(\underset{\bar{}}{x}) &= \sum_{i=1}^n x_i \\
h(\underset{\bar{}}{x}) &= \prod_{i=1}^n \mathcal{I}_{\{x_i \geq0\}}
\end{aligned}
$$

Entonces el estad铆stico ($T_1$ desde ahora) es igual $r(\underset{\bar{}}{X})$, de manera que el mismo queda definido como:

$$
\begin{aligned}
T_1 &= r(\underset{\bar{}}{X}) \\
T_1 &= \sum_{i=1}^n X_i 
\end{aligned}
$$

Recuperando el estad铆stico propuesto en el enunciado del problema y teniendo en cuenta que $C(\lambda)$ es una funci贸n decreciente con $\lambda$, estamos en condiciones de escribir el test uniformemente m谩s potente (UMP) de la siguiente forma:

$$
\begin{aligned}
    \delta(\underset{\bar{}}{X}) =
    \begin{cases}
      1 \quad si \quad -\sum_{i=1}^n X_i > K_{\alpha} \\
      0 \quad si \quad no
    \end{cases}\, ,
\end{aligned}
$$

con $K_{\alpha}$ tal que: 

$$
\begin{aligned}
  P_{\lambda=0.5}[\delta(\underset{\bar{}}{X})=1] = \alpha
\end{aligned} .
$$

Entonces, lo siguiente que tenemos que hacer es calcular $K_{\alpha}$, y para esto vemos a "pararnos" en un mundo en el que $H_0$ es verdadera. Bajo el mundo $H_0$, vamos a considerar al par谩metro como $\lambda = 0.5$ y, por lo tanto, la distribuci贸n de cada una de las variables aleatorias ser谩 $X_i \overset{i.i.d}\sim \mathcal E(\frac{1}{2})$. Con esto en mente, podemos determinar la distribuci贸n de la suma de variables aleatorias (que es el estad铆stico $T_1$):

$$
\begin{aligned}
  \sum_{i=1}^n X_i &\sim  \Gamma\left(n,\frac{1}{2}\right) \\
  &\sim  \chi^2_{2n}
\end{aligned}
$$

Es decir, la suma de variables aleatorias $X_i \overset{i.i.d}\sim \mathcal E(\frac{1}{2})$ tiene distribuci贸n $\chi^2_{2n}$. Entonces ahora vayamos a despejar $K_{\alpha}$ de la condici贸n $P_{\lambda=0.5}[\delta(\underset{\bar{}}{X})=1] = \alpha$

$$
\begin{aligned}
  \alpha &= P_{\lambda=0.5}[\delta(\underset{\bar{}}{X})=1] \\
  &= P_{\lambda=0.5}(-\sum_{i=1}^n X_i > K_{\alpha}) \\
  &= P_{\lambda=0.5}(\sum_{i=1}^n X_i < -K_{\alpha}) \\
  &= P_{\lambda=0.5}(\sum_{i=1}^n X_i < \chi^2_{2n,\alpha}) 
\end{aligned}
$$

Es decir, $-K_{\alpha}$ es igual al cuantil $\alpha$ de la distribuci贸n Chi cuadrado de grados de libertad $2n$ ($\chi^2_{2n,\alpha}$).

Por ejemplo, en la figura que se muestra a continuaci贸n podemos ver, para $n=10$ y $\alpha=0.05$, el cuantil de la distribuci贸n (l铆nea roja vertical, $\chi^2_{2n,\alpha}$) junto con el 谩rea gris que representa a la probabilidad acumulada de $\alpha = 0.05$.

```{r, echo=FALSE, warning=FALSE, fig.height = 4, fig.width = 4, fig.align = "center"}
n <- 10
df <- 2*n
alpha <- .05

dist <- tibble(x = seq(0, 50, .01),
               y = dchisq(x = x, df = df))

cuantil <- qchisq(p = alpha, df = df)

dist %>%
  ggplot(aes(x = x, y = y)) +
  geom_vline(xintercept = cuantil, 
             alpha = .4, 
             color = "red") +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_area(data = dist %>% filter(x<cuantil),
            aes(x = x, y = y, linetype = "dashed"),
            alpha = .4) +
  geom_line(color = "red") +
  annotate("text", x = cuantil, 
           y = dchisq(x = cuantil, df = df), 
           label = TeX("$\\chi^2_{2n,\\alpha}$"), 
           hjust = 1.1,
           vjust = -.1) +
  annotate("text", 
           x = 9, 
           y =0.005, 
           label = TeX("$\\alpha$")) +
  labs(x = "x", 
       y = "f(x)") +
  theme_bw() +
  theme(legend.position = "none")
    
```

Finalmente, podemos definir al test de nivel exacto como:

$$
\begin{aligned}
    \delta(\underset{\bar{}}{x}) =
    \begin{cases}
      1 \quad si \quad \sum_{i=1}^n X_i < \chi^2_{2n,\alpha} \\
      0 \quad si \quad no
    \end{cases}\,.
\end{aligned}
$$

Ahora sigamos con el **test de nivel asint贸tico** $\alpha$.

Partimos de nuevo de que las mediciones son i.i.d y tienen la siguiente distribuci贸n:

$$
\begin{aligned}
X_1,...,X_n \overset{i.i.d}\sim \mathcal E(\lambda)
\end{aligned}
$$

Sabemos que $E(X_i) = \frac{1}{\lambda}$ y que $V(X_i) = \frac{1}{\lambda^2}$, por lo tanto $E(\bar{X}) = \frac{1}{\lambda}$ y que $V(\bar{X}) = \frac{1}{n} \frac{1}{\lambda^2}$. Entonces, usando el teorema central del l铆mite podemos decir que:

$$
\begin{aligned}
\frac{\bar{X}-\frac{1}{\lambda}}{\sqrt{\frac{1}{n\lambda^2}}} &\overset{\mathcal{D}}\rightarrow \mathcal{N}(0,1) \\
\sqrt{n} \frac{\bar{X}-\frac{1}{\lambda}}{1/\lambda} &\overset{\mathcal{D}}\rightarrow \mathcal{N}(0,1)
\end{aligned}
$$

Ahora volvemos a "pararnos" en $H_0$ y a considerar a $\lambda = 0.5$ (el supremo de $\Theta_1$) y nos queda:

$$
\begin{aligned}
\sqrt{n} \frac{\bar{X}-\frac{1}{0.5}}{1/0.5} &\overset{\mathcal{D}}\rightarrow \mathcal{N}(0,1) \\
\sqrt{n} \frac{\bar{X}-2}{2} &\overset{\mathcal{D}}\rightarrow \mathcal{N}(0,1) \, ,
\end{aligned}
$$

que corresponde con el estad铆stico $T_2$ planteado en el enunciado. Luego, hallamos un $K'_{\alpha}$ tal que:

$$
\begin{aligned}
  P_{\lambda=0.5}\left(\sqrt{n} \frac{\bar{X}-2}{2} < K'_{\alpha}\right) &\overset{n \to \infty}\rightarrow \alpha
\end{aligned} .
$$

De forma que el test asint贸tico de nivel $\alpha$ queda definido como:

$$
\begin{aligned}
    \delta(\underset{\bar{}}{x}) =
    \begin{cases}
      1 \quad si \quad \sqrt{n} \frac{\bar{X}-2}{2} < Z_\alpha \\
      0 \quad si \quad no
    \end{cases}\
\end{aligned}.
$$

En este caso el cuantil que tenemos que buscar es el de una distribuci贸n $\mathcal{N}(0,1)$. Por ejemplo, para $\alpha=0.05$:

```{r, echo=FALSE, warning=FALSE, fig.height = 4, fig.width = 4, fig.align = "center"}
n <- 10
df <- 2*n
alpha <- .05

dist <- tibble(x = seq(-3, 3, .01),
               y = dnorm(x = x))

cuantil <- qnorm(p = alpha)

dist %>%
  ggplot(aes(x = x, y = y)) +
  geom_vline(xintercept = cuantil, 
             alpha = .4, 
             color = "red") +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_area(data = dist %>% filter(x<cuantil),
            aes(x = x, y = y, linetype = "dashed"),
            alpha = .4) +
  geom_line(color = "red") +
  annotate("text", x = cuantil, 
           y = dnorm(x = cuantil), 
           label = TeX("$z_{\\alpha}$"), 
           hjust = 1.1,
           vjust = -.1) +
  annotate("text", 
           x = -2, 
           y = 0.02, 
           label = TeX("$\\alpha$")) +
  labs(x = "x", 
       y = "f(x)") +
  theme_bw() +
  theme(legend.position = "none")
```

## c. Realizar la simulaci贸n pedida para los diferentes valores de $n$, calcular el nivel emp铆rico y expresarlo en una tabla.

Ahora lo que vamos a hacer es simular el "experimento", generando muestras de tamao $n$ con distribucin $\mathcal E(\frac{1}{2})$, y medir la cantidad de veces que se rechaz贸 $H_0$ para ver cmo se relaciona eso con el $n$ para cada uno de los tests propuestos (el UMP y el asint贸tico). Vamos a realizar `Nrep=10000` simulaciones de cada test con valores de `n = c(10,30,100,1000)`.

```{r}
# La funci贸n simulaci贸n simula el experimento y se fija el resultado del test
simulacion_UMP <- function(Nrep, n, lambda){
  rechazos <- rep(NA,Nrep)
  for (i in 1:Nrep) {
    set.seed(2*i) # Para tener la misma muestra para cada simulaci贸n
    muestra <- rexp(n, lambda)
    estadistico <- sum(muestra) # El estad铆stico del test UMP
    rechazos[i] <- pchisq(estadistico, 2*n)<0.05 # El test compara con Chisq
  }
  
  alpha_emp <- mean(rechazos)
  return(alpha_emp)
}

simulacion_asin <- function(Nrep, n, lambda){
  rechazos <- rep(NA,Nrep)
  for (i in 1:Nrep) {
    set.seed(2*i) # Para tener la misma muestra para cada simulaci贸n
    muestra <- rexp(n, lambda)
    estadistico <- sqrt(n)*(mean(muestra)-2)/2 # El estad铆stico del test asint贸tico
    rechazos[i] <- pnorm(estadistico, 0, 1)<0.05 # El test compara con Norm
  }
  
  alpha_emp <- mean(rechazos)
  return(alpha_emp)
}

set.seed(123)
ns <- c(10,30,100,1000)

tabla <- tibble(n = ns) %>%
  rowwise() %>%
  mutate(alpha_emp_UMP = simulacion_UMP(Nrep = 10000, n = n, lambda = 0.5),
         alpha_emp_asin = simulacion_asin(Nrep = 10000, n = n, lambda = 0.5)) 

tabla %>%
  knitr::kable(col.names = c("n", "alfa emp铆rico UMP", "alfa emp铆rico asint贸tico"))

```

## d. Para cada uno de los valores propuestos de $n$ y eligiendo una grilla de valores para $\lambda$, aproximar y graficar la funci贸n potencia.

Para estas simulaciones vamos a utilizar el mismo `Nrep` y los mismos valores de `n` del inciso anterior pero nos vamos a mover del $\lambda = 0.5$ y vamos a barrer valores de lambda desde $0.1$ a $1$, con un paso de $0.01$. De esta manera, para los distintos valores de $\lambda$ generaremos muestras con distribucin $\mathcal E(\lambda)$ y estimaremos la probabiliad de rechazar $H_0$ (es decir, la potencia) a partir de la proporcin emprica de rechazos.

```{r, fig.height = 8, fig.width = 8, fig.align = "center"}
# La funci贸n simulaci贸n simula el experimento y se fija el resultado del test
set.seed(123)
ns <- c(10,30,100,1000) # Posibles ns
lambdas <- seq(0.1,1,.01) # Rango de lambdas

potencias <- expand_grid(n = ns, Lambda = lambdas) %>%
  rowwise() %>%
  mutate(UMP = simulacion_UMP(Nrep = 10000, n = n, lambda = Lambda),
         Asintotico = simulacion_asin(Nrep = 1000, n = n, lambda = Lambda)) %>%
  pivot_longer(cols = !c(n, Lambda), names_to = "Test", values_to = "Potencia")
```

```{r, echo = FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
potencias %>% ggplot(aes(x = Lambda,
                         y = Potencia,
                         color = Test)) +
  geom_vline(xintercept = 0.5, color = "gray70", linetype = "dashed") +
  geom_hline(yintercept = 0.05, color = "gray70", linetype = "dashed") +
  geom_line(linewidth = 1, alpha = .6) +
  facet_wrap(.~n, labeller = label_both) +
  theme_bw() +
  theme(legend.position = "top")
```

En la figura podemos ver la funci贸n potencia $adsf$ para el test UMP (celeste) y asint贸tico (rosa) en funci贸n del $\lambda$ y separado para distintos valores de n. Se observa que para n peque帽o (<100) hay una diferencia en la potencia emp铆rica a favor del test UMP, que en esta figura puede verse principalmente para la zona de $\lambda>0.5$. Si quisi茅ramos ver m谩s en detalle que pasa en la regi贸n de $\Theta_1$, podemos hacer un zoom.

```{r, echo = FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
potencias %>% 
    filter(Lambda<=0.5) %>%
  ggplot(aes(x = Lambda,
             y = Potencia,
             color = Test)) +
  geom_vline(xintercept = 0.5, color = "gray70", linetype = "dashed") +
  geom_hline(yintercept = 0.05, color = "gray70", linetype = "dashed") +
  geom_line(linewidth = 1, alpha = .6) +
  geom_point(data = potencias %>% filter(Lambda==0.5), size = 3, pch = 18) +
  facet_wrap(.~n, labeller = label_both) +
  theme_bw() +
  theme(legend.position = "top")
```

Ac谩 podemos er claramente que para $n<100$ tambi茅n resulta conveniente (desde el punto de vista de la potencia) utilizar el test UMP. Tambi茅n se ve claramente como la potencia para $\lambda=0.5$ est谩 muy cercana al $0.05$ para el test UMP (con alguna variabilidad porque son simulaciones) pero da bastante inferior para el test asint贸tico.

Otra cosa que podemos ver es como var铆a la potencia para cada test con el $n$. 

```{r, echo = FALSE, fig.height = 4, fig.width = 8, fig.align = "center"}
potencias %>% ggplot(aes(x = Lambda,
                         y = Potencia,
                         color = factor(n))) +
  geom_vline(xintercept = 0.5, color = "gray70", linetype = "dashed") +
  geom_hline(yintercept = 0.05, color = "gray70", linetype = "dashed") +
  geom_line(linewidth = 1, alpha = .6) +
  facet_wrap(.~Test, labeller = label_both) +
  theme_bw() +
  theme(legend.position = "top")
```

En este caso la conclusi贸n principal, y algo trivial, es que al aumentar el $n$ la potencia "mejora" (la pendiente es m谩s empinada). Y lo mismo lo podemos ver para los $\lambda<0.5$

```{r, echo = FALSE, fig.height = 4, fig.width = 8, fig.align = "center"}
potencias %>% 
  filter(Lambda<=0.5) %>%
  ggplot(aes(x = Lambda,
             y = Potencia,
             color = factor(n))) +
  geom_vline(xintercept = 0.5, color = "gray70", linetype = "dashed") +
  geom_hline(yintercept = 0.05, color = "gray70", linetype = "dashed") +
  geom_line(linewidth = 1, alpha = .6) +
  geom_point(data = potencias %>% filter(Lambda==0.5), size = 5, pch = 18) +
  facet_wrap(.~Test, labeller = label_both) +
  theme_bw() +
  theme(legend.position = "top")
```

## e. Concluir en base a los resultados observados.
